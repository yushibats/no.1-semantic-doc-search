#cloud-config
output: {all: '| tee -a /var/log/cloud-init-custom.log'}
bootcmd:
  - mkdir -p /u01/aipoc/props
package_update: true
package_upgrade: false
packages:
  - git
  - unzip
  - poppler-utils
  - nginx
  - netfilter-persistent
write_files:
  - path: "/u01/aipoc/props/db.env"
    permissions: "0644"
    encoding: "gzip+base64"
    content: |
      ${db_conn}
  - path: "/u01/aipoc/props/adb_name.txt"
    permissions: "0644"
    content: ${adb_name}
  - path: "/u01/aipoc/props/compartment_id.txt"
    permissions: "0644"
    content: ${comp_id}
  - path: "/u01/aipoc/props/db_password.txt"
    permissions: "0644"
    content: ${db_pass}
  - path: "/u01/aipoc/props/adb_dsn.txt"
    permissions: "0644"
    content: ${db_dsn}
  - path: "/u01/aipoc/props/oci_bucket.txt"
    permissions: "0644"
    content: ${bucket}
  - path: "/u01/aipoc/props/dify_bucket.txt"
    permissions: "0644"
    content: ${dify_bucket}
  - path: "/u01/aipoc/props/adb_ocid.txt"
    permissions: "0644"
    content: ${adb_ocid}
  - path: "/u01/aipoc/props/enable_dify.txt"
    permissions: "0644"
    content: |
      ${enable_dify}
  - path: "/u01/aipoc/props/dify_branch.txt"
    permissions: "0644"
    content: |
      ${dify_branch}
  - path: "/u01/aipoc/props/bucket_region.txt"
    permissions: "0644"
    content: |
      ${bucket_region}
  - path: "/u01/aipoc/props/bucket_namespace.txt"
    permissions: "0644"
    content: |
      ${bucket_namespace}
  - path: "/u01/aipoc/props/oci_access_key.txt"
    permissions: "0644"
    content: |
      ${oci_access_key}
  - path: "/u01/aipoc/props/oci_secret_key.txt"
    permissions: "0644"
    content: |
      ${oci_secret_key}
  - path: "/u01/aipoc/props/adb_password.txt"
    permissions: "0644"
    content: ${adb_pass}
  - path: "/u01/aipoc/wallet.zip"
    permissions: "0644"
    encoding: base64
    content: |
      ${wallet}
runcmd:
  - apt install -y git unzip poppler-utils nginx netfilter-persistent
  - iptables -I INPUT 6 -m state --state NEW -p tcp --dport 80 -j ACCEPT
  - netfilter-persistent save
  - systemctl enable nginx
  - systemctl start nginx
  - cd /u01/aipoc
  - git clone https://github.com/engchina/no.1-semantic-doc-search.git
  - cd /u01/aipoc/no.1-semantic-doc-search
  - chmod +x init_script.sh
  - nohup bash init_script.sh >> /var/log/cloud-init-custom.log 2>&1 &